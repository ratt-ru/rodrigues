db:
  image: postgres:9.3

broker:
  image: dockerfile/rabbitmq

mail:
  build: postfix
  ports:
    - 25:25
  # somehow the docker DNS server can't resolve MX records so we use google
  dns: 8.8.8.8

## redis is used by sentry
#redis:
#  image: redis:latest

## sentry is used for log collecting
#sentry:
#  image: slafs/sentry
#  environment:
#   - SECRET_KEY="please change me"
#   - SENTRY_URL_PREFIX=http://192.168.59.103:9000/
#   - SENTRY_ADMIN_USERNAME=gijs
#   - SENTRY_ADMIN_PASSWORD=gijsgijs
#   - SENTRY_ADMIN_EMAIL=root@localhost
#   - SENTRY_REDIS_HOST=redis
#  ports:
#    - 9000:9000
#  links:
#    - redis

worker:
 build: django_kat
 command: celery worker -A django_kat -l INFO
 links:
   - broker
   - db
   - mail
 environment:
   - DJANGO_SETTINGS_MODULE=django_kat.settings.container
   - C_FORCE_ROOT=true
   - SECRET_KEY="doesn't matter"
 volumes:
  - /var/run/docker.pid:/var/run/docker.pid
  - /var/run/docker.sock:/var/run/docker.sock
  - /var/lib/docker:/var/lib/docker
  - /code/results
  - /code/uploaded

django:
  build: django_kat
  command: uwsgi --socket django_kat.sock --module django_kat.wsgi --chmod-socket=666
  links:
    - db
    - broker
    - mail
    - sentry
  environment:
    - DJANGO_SETTINGS_MODULE=django_kat.settings.container
    - SECRET_KEY=please change me
    - ALLOWED_HOST=192.168.59.103
    - CYBERSKA_URL=http://192.168.59.103:8081/v1/viz
    - ADMIN_EMAIL=root@localhost
    #- DEBUG=true
    #- SENTRY_DSN=http://1c6a0e5af24d462787ae4db89d097790:039fdb4b28964af29a8c9d648ed45973@192.168.59.103:9000//2
  volumes:
    - /code
  volumes_from:
    - worker

nginx:
  build: nginx
  volumes_from:
    - django
  ports:
    - 80:80

viewer:
  image: gijzelaerr/cyberska_viewer
  volumes_from:
    - worker
  ports:
    - 8081:80
    - 8080:8080
  environment:
    - REDIRECT_HOST=192.168.59.103
    - REDIREC_PORT=8080

## you can enable this if you want to examine the worker queue
#flower:
# build: django_kat
# command: celery flower -A django_kat --logging=warning
# links:
#   - broker
# environment:
#   - DJANGO_SETTINGS_MODULE=django_kat.settings.container
#   - SECRET_KEY="doesn't matter"
# ports:
#   - 5555:5555


